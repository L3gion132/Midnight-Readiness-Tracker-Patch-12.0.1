<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Readiness V1</title>
    <style>
        :root {
            --bg-color: #1a1a1d; --panel-bg: #2d2d33; --text-color: #ffffff;
            --theme-color: #9b59b6; --theme-glow: rgba(155, 89, 182, 0.4);
            --accent-valor: #d63031; --accent-crests: #e1b12c;
            --r-none: #444; --r-veteran: #0070dd; --r-champion: #a335ee; 
            --r-hero: #00ff96; --r-myth: #ff8000; --r-crafted: #f1c40f; 
            --c-weathered: #b2bec3; --c-carved: #55efc4; --c-runed: #0984e3; --c-gilded: #fdcb6e;
        }

        [data-theme="DK"] { --theme-color: #C41F3B; --theme-glow: rgba(196, 31, 59, 0.4); }
        [data-theme="DH"] { --theme-color: #A330C9; --theme-glow: rgba(163, 48, 201, 0.4); }
        [data-theme="Druid"] { --theme-color: #FF7D0A; --theme-glow: rgba(255, 125, 10, 0.4); }
        [data-theme="Evoker"] { --theme-color: #33937F; --theme-glow: rgba(51, 147, 127, 0.4); }
        [data-theme="Hunter"] { --theme-color: #ABD473; --theme-glow: rgba(171, 212, 115, 0.4); }
        [data-theme="Mage"] { --theme-color: #40C7EB; --theme-glow: rgba(64, 199, 235, 0.4); }
        [data-theme="Monk"] { --theme-color: #00FF96; --theme-glow: rgba(0, 255, 150, 0.4); }
        [data-theme="Paladin"] { --theme-color: #F58CBA; --theme-glow: rgba(245, 140, 186, 0.4); }
        [data-theme="Priest"] { --theme-color: #FFFFFF; --theme-glow: rgba(255, 255, 255, 0.4); }
        [data-theme="Rogue"] { --theme-color: #FFF569; --theme-glow: rgba(255, 245, 105, 0.4); }
        [data-theme="Shaman"] { --theme-color: #0070DE; --theme-glow: rgba(0, 112, 222, 0.4); }
        [data-theme="Warlock"] { --theme-color: #8787ED; --theme-glow: rgba(135, 135, 237, 0.4); }
        [data-theme="Warrior"] { --theme-color: #C79C6E; --theme-glow: rgba(199, 156, 110, 0.4); }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 15px; height: 100vh; width: 100vw;
            overflow: hidden; display: flex; justify-content: center;
        }
        .main-container { width: 100%; max-width: 1400px; height: 100%; display: flex; flex-direction: column; gap: 15px; }
        .profile-bar { background: var(--panel-bg); padding: 10px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--theme-color); box-shadow: 0 5px 15px rgba(0,0,0,0.3); flex-shrink: 0; }
        .app-wrapper { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .panel { background-color: var(--panel-bg); padding: 1.5rem; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-top: 4px solid var(--theme-color); height: 100%; display: flex; flex-direction: column; }
        .char-panel { flex: 1; min-width: 340px; }
        .tracker-panel { flex: 1.2; min-width: 320px; }
        .gear-scroll-container { flex: 1; overflow-y: auto; padding-right: 5px; margin-top: 10px; }
        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; overflow-y: auto; padding-right: 5px; }
        
        .profile-select { padding: 8px; font-size: 0.9rem; background: #222; color: white; border: 1px solid #555; border-radius: 6px; min-width: 200px; }
        .btn-profile { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px; font-size: 0.85rem;}
        .btn-new { background: var(--theme-color); color: #1a1a1d; }
        .btn-del { background: #d63031; color: white; opacity: 0.7; }
        .char-header { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; justify-content: space-between; flex-shrink: 0;}
        .char-input { background: #222; border: 1px solid #444; color: var(--theme-color); padding: 8px; border-radius: 6px; font-size: 1.1rem; font-weight: bold; width: 60%; font-family: inherit; }
        .ilvl-display { background: #202024; padding: 5px 10px; border-radius: 8px; border: 1px solid #444; text-align: center; }
        .ilvl-number { font-size: 1.2rem; font-weight: bold; color: var(--theme-color); display: block; line-height: 1; }
        .ilvl-label { font-size: 0.6rem; color: #888; text-transform: uppercase; }
        .gear-grid { display: grid; gap: 6px; }
        .gear-slot { display: flex; align-items: center; background: #26262b; padding: 6px; border-radius: 6px; border-left: 4px solid #444; }
        .slot-label { width: 70px; font-size: 0.7rem; color: #aaa; text-transform: uppercase; font-weight: bold; }
        .slot-select { background: #333; color: white; border: none; padding: 4px; border-radius: 4px; margin-left: 5px; font-size: 0.8rem; cursor: pointer; }
        .tier-select { flex-grow: 1; }
        .level-select { width: 50px; }
        .crafted-input { width: 50px; background: #444; border: 1px solid #f1c40f; color: #f1c40f; padding: 4px; border-radius: 4px; font-weight: bold; text-align: center; display: none; margin-left: 5px; font-size:0.8rem;}
        .item-ilvl { width: 35px; text-align: right; font-size: 0.8rem; color: #fff; font-weight: bold; margin-left: 5px; }
        .gear-slot[data-rarity="None"] { border-left-color: var(--r-none); opacity: 0.5; }
        .gear-slot[data-rarity="Veteran"] { border-left-color: var(--r-veteran); }
        .gear-slot[data-rarity="Champion"] { border-left-color: var(--r-champion); }
        .gear-slot[data-rarity="Hero"] { border-left-color: var(--r-hero); }
        .gear-slot[data-rarity="Myth"] { border-left-color: var(--r-myth); box-shadow: 0 0 10px rgba(255, 128, 0, 0.1); }
        .gear-slot[data-rarity="Crafted"] { border-left-color: var(--r-crafted); }

        .tab-nav { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; flex-shrink: 0;}
        .tab-btn { flex: 1; padding: 8px; background: none; border: none; color: #888; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; font-size:0.9rem;}
        .tab-btn.active { color: white; border-bottom-color: var(--theme-color); }
        
        /* SUB TABS */
        .sub-nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .sub-btn { flex: 1; padding: 8px; background: #222; border: 1px solid #444; color: #888; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .sub-btn.active { background: var(--theme-color); color: #1a1a1d; font-weight: bold; border-color: var(--theme-color); }
        .cfg-container { display: none; flex-direction: column; height: 100%; }
        .cfg-container.active { display: flex; }

        .counter-display { font-size: 3.5rem; font-weight: bold; margin: 5px 0; color: var(--theme-color); line-height: 1; text-shadow: 0 0 15px var(--theme-glow); }
        .sub-text { color:#b2bec3; margin-bottom: 15px; font-size: 0.9rem; }
        .strategy-box { background: #202024; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #444; text-align: left; }
        .strategy-label { display: block; font-size: 0.7rem; color: #aaa; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 1px; }
        .strategy-select { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: white; border-radius: 6px; font-size:0.9rem;}
        .planner { background: #26262b; padding: 10px; border-radius: 12px; border: 1px solid #3a3a40; margin-bottom: 15px; }
        .planner-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 8px; }
        .planner-val { font-weight: bold; font-size: 1.1rem; color: #fff; }
        .planner-sub { font-size: 0.65rem; color: #888; text-transform: uppercase; }
        .pace-val { color: var(--theme-color); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; background: #222; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .stat-box { padding: 5px; display: flex; flex-direction: column; }
        .stat-label { font-size: 0.65rem; color: #b2bec3; text-transform: uppercase; margin-bottom: 3px;}
        .stat-input { font-size: 1.1rem; font-weight: bold; background: transparent; border: none; border-bottom: 1px dashed #555; color: #fff; width: 100%; }
        .valor-box { border-left: 3px solid var(--accent-valor); padding-left: 8px; }
        .crest-box { border-left: 3px solid var(--accent-crests); padding-left: 8px; }
        .progress-container { margin-top: 4px; background: #444; height: 4px; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.3s ease; }
        .btn-add { background-color: var(--theme-color); color: #1a1a1d; width:100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-bottom: 8px;}
        .btn-undo { background: transparent; color: #666; border: 1px solid #666; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .crest-gilded { color: var(--c-gilded); font-weight: bold; }
        .crest-runed { color: var(--c-runed); }
        .crest-carved { color: var(--c-carved); }
        .crest-weathered { color: var(--c-weathered); }

        .footer { margin-top: auto; padding-top: 10px; border-top: 1px solid #333; text-align: center; color: #555; font-size: 0.75rem; width: 100%; flex-shrink: 0; }
        .modal { display: none; position: fixed; z-index: 99; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #333; margin: 15% auto; padding: 20px; border-radius: 10px; width: 300px; border: 2px solid var(--theme-color); text-align: center; }
        .modal input, .modal select { width: 100%; padding: 10px; margin: 10px 0; background: #222; color: white; border: 1px solid #555; border-radius: 4px; }
        
        .settings-scroll { overflow-y: auto; margin-top: 5px; border: 1px solid #444; border-radius: 6px; }
        .settings-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .settings-table th { text-align: left; padding: 8px; background: #26262b; position: sticky; top: 0; z-index: 2; color: #aaa; }
        .settings-table td { padding: 6px; border-bottom: 1px solid #333; background: #2d2d33; }
        .settings-table input, .settings-table select { background: #111; color: white; border: 1px solid #444; padding: 4px; width: 100%; border-radius: 3px; }
        @media (max-width: 768px) { body { height: auto; overflow: auto; } .app-wrapper { flex-direction: column; } }
    </style>
</head>
<body>

<div class="main-container">
    <div class="profile-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <strong style="color:#aaa;">CHARACTER:</strong>
            <select id="profileSelect" class="profile-select" onchange="switchProfile(this.value)"></select>
        </div>
        <div>
            <button class="btn-profile btn-new" onclick="openModal()">+ New</button>
            <button class="btn-profile btn-del" onclick="deleteProfile()">Delete</button>
        </div>
    </div>

    <div class="app-wrapper">
        <div class="panel char-panel">
            <div class="char-header">
                <input type="text" class="char-input" id="charName" placeholder="Name" onchange="saveCharName()">
                <div class="ilvl-display"><span class="ilvl-number" id="avgIlvl">0</span><span class="ilvl-label">Avg</span></div>
            </div>
            <div class="gear-scroll-container"><div class="gear-grid" id="gearGrid"></div></div>
        </div>

        <div class="panel tracker-panel">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('dashboard')">Tracker</button>
                <button class="tab-btn" onclick="switchTab('settings')">Config</button>
            </div>

            <div id="tab-dashboard" class="tab-content active">
                <div class="strategy-box">
                    <label class="strategy-label">Farming Strategy</label>
                    <select class="strategy-select" id="activeRunSelect" onchange="render()"></select>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: #ccc; display: flex; justify-content: space-between;">
                        <span>Valor: <span id="infoValor" style="color:var(--accent-valor)">0</span></span>
                        <span id="conversionDisplay" style="text-align: right; color: #aaa;"></span>
                    </div>
                </div>
                <div style="text-align:center;">
                    <div class="counter-display" id="runsRemaining">0</div>
                    <div class="sub-text">Runs Remaining</div>
                </div>
                <button class="btn-add" onclick="updateRuns(1)">Run Complete (-1)</button>
                <button class="btn-undo" onclick="updateRuns(-1)">Undo Mistake (+1)</button>
                <div class="planner">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="planner-sub">TARGET DATE</span>
                        <input type="date" style="background:#333; color:white; border:none; padding:4px; border-radius:4px; font-size:0.8rem;" id="targetDate" onchange="render()">
                    </div>
                    <div class="planner-grid">
                        <div class="planner-item"><span class="planner-val" id="weeksLeft">0</span><span class="planner-sub">Weeks</span></div>
                        <div class="planner-item"><span class="planner-val pace-val" id="runsPerWeek">0</span><span class="planner-sub">Per Week</span></div>
                        <div class="planner-item"><span class="planner-val pace-val" id="runsPerDay">0</span><span class="planner-sub">Per Day</span></div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box valor-box">
                        <span class="stat-label">Valor Goal</span>
                        <input type="number" class="stat-input" id="valorGoalInput" value="3436" onchange="updateGoals()">
                        <div class="stat-label" style="margin-top:2px;">Rem: <span id="valorReal">0</span></div>
                        <div class="progress-container"><div class="progress-bar" id="valorBar" style="background: var(--accent-valor); width: 0%"></div></div>
                    </div>
                    <div class="stat-box crest-box">
                        <span class="stat-label">Gilded Goal</span>
                        <input type="number" class="stat-input" id="crestGoalInput" value="390" onchange="updateGoals()">
                        <div class="stat-label" style="margin-top:2px;">Rem: <span id="crestReal">0</span></div>
                        <div class="progress-container"><div class="progress-bar" id="crestBar" style="background: var(--accent-crests); width: 0%"></div></div>
                    </div>
                </div>
            </div>

            <div id="tab-settings" class="tab-content">
                <div class="sub-nav">
                    <button id="btn-cfg-delves" class="sub-btn active" onclick="switchConfigSub('delves')">Delves</button>
                    <button id="btn-cfg-dungeons" class="sub-btn" onclick="switchConfigSub('dungeons')">Dungeons</button>
                </div>

                <div id="cfg-delves" class="cfg-container active">
                    <div class="settings-scroll" style="flex:1;">
                        <table class="settings-table">
                            <thead><tr><th>Tier</th><th>Valor</th><th>Type</th><th>Amt</th></tr></thead>
                            <tbody id="delveSettingsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="cfg-dungeons" class="cfg-container">
                    <div class="settings-scroll" style="flex:1;">
                        <table class="settings-table">
                            <thead><tr><th>Key</th><th>Valor</th><th>Type</th><th>Amt</th></tr></thead>
                            <tbody id="dungeonSettingsBody"></tbody>
                        </table>
                    </div>
                </div>

                <button class="btn-undo" style="width:100%; margin-top:15px; color:#d63031; border-color:#d63031; padding:10px;" onclick="resetDefaults()">Reset Config to Defaults</button>
            </div>
        </div>
    </div>
    <div class="footer"><strong>© 2026 Lil_ArtGhoul. All Rights Reserved.</strong><br>Patch 12.0.1 Readiness Tool</div>
</div>

<div id="newCharModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--theme-color)">New Character</h3>
        <input type="text" id="newCharName" placeholder="Name">
        <select id="newCharClass">
            <option value="DK">Death Knight</option><option value="DH">Demon Hunter</option><option value="Druid">Druid</option>
            <option value="Evoker">Evoker</option><option value="Hunter">Hunter</option><option value="Mage">Mage</option>
            <option value="Monk">Monk</option><option value="Paladin">Paladin</option><option value="Priest">Priest</option>
            <option value="Rogue">Rogue</option><option value="Shaman">Shaman</option><option value="Warlock">Warlock</option>
            <option value="Warrior">Warrior</option>
        </select>
        <button class="btn-profile btn-new" style="width:100%; margin-top:10px;" onclick="createProfile()">Create</button>
        <button class="btn-undo" style="width:100%; margin-top:10px; border:none;" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
    const SLOTS = ['Head', 'Neck', 'Shoulders', 'Back', 'Chest', 'Wrist', 'Hands', 'Waist', 'Legs', 'Feet', 'Ring A', 'Ring B', 'Trinket A', 'Trinket B', 'Main Hand', 'Off Hand'];
    const TIERS = ['None', 'Veteran', 'Champion', 'Hero', 'Myth', 'Crafted'];
    const LEVELS = ['1/8', '2/8', '3/8', '4/8', '5/8', '6/8', '7/8', '8/8'];
    const ILVL_RANGES = { 'None': [0, 0], 'Veteran': [108, 131], 'Champion': [121, 144], 'Hero': [134, 157], 'Myth': [147, 160], 'Crafted': [0, 0] };
    const CONVERSION = { 'Gilded': 1, 'Runed': 1/3, 'Carved': 1/9, 'Weathered': 1/27 };
    
    // UPDATED CONFIG WITH TABBED DATA
const DEFAULT_CONFIG = {
        delves: [
            { id: 'd1', name: 'Tier 1', valor: 15, type: 'Weathered', amt: 2 },
            { id: 'd2', name: 'Tier 2', valor: 20, type: 'Weathered', amt: 4 },
            { id: 'd3', name: 'Tier 3', valor: 25, type: 'Weathered', amt: 6 },
            { id: 'd4', name: 'Tier 4', valor: 30, type: 'Carved', amt: 2 },
            { id: 'd5', name: 'Tier 5', valor: 35, type: 'Carved', amt: 4 },
            { id: 'd6', name: 'Tier 6', valor: 40, type: 'Runed', amt: 2 },
            { id: 'd7', name: 'Tier 7', valor: 50, type: 'Gilded', amt: 4 },
            { id: 'd8', name: 'Tier 8', valor: 65, type: 'Gilded', amt: 5 },
            { id: 'd9', name: 'Tier 9', valor: 65, type: 'Runed', amt: 5 },
            { id: 'd10', name: 'Tier 10', valor: 65, type: 'Runed', amt: 5 },
            { id: 'd11', name: 'Tier 11', valor: 65, type: 'Runed', amt: 15 }
        ],
        dungeons: [
            { id: 'm0', name: 'Mythic 0', valor: 30, type: 'Carved', amt: 10 },
            { id: 'm2', name: 'Mythic +2', valor: 65, type: 'Carved', amt: 12 },
            { id: 'm3', name: 'Mythic +3', valor: 65, type: 'Carved', amt: 12 },
            { id: 'm4', name: 'Mythic +4', valor: 65, type: 'Runed', amt: 12 },
            { id: 'm5', name: 'Mythic +5', valor: 65, type: 'Runed', amt: 12 },
            { id: 'm6', name: 'Mythic +6', valor: 65, type: 'Runed', amt: 12 },
            { id: 'm7', name: 'Mythic +7', valor: 65, type: 'Runed', amt: 12 },
            { id: 'm8', name: 'Mythic +8', valor: 65, type: 'Runed', amt: 12 },
            { id: 'm9', name: 'Mythic +9', valor: 65, type: 'Gilded', amt: 12 },
            { id: 'm10', name: 'Mythic +10', valor: 65, type: 'Gilded', amt: 12 }
        ]
    };

    let profiles = [];
    let activeProfileId = null;
    let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

    window.onload = function() {
        if(localStorage.getItem('dt_config')) config = JSON.parse(localStorage.getItem('dt_config'));
        
        if(localStorage.getItem('dt_profiles')) {
            profiles = JSON.parse(localStorage.getItem('dt_profiles'));
            profiles.forEach(p => {
                if(!p.gear) p.gear = {};
                SLOTS.forEach(s => {
                    if(!p.gear[s] || typeof p.gear[s] !== 'object') p.gear[s] = { tier: 'Veteran', level: '1/8', customIlvl: 150 };
                });
            });
        } else {
            profiles = [{ id: Date.now(), name: "Main Character", class: "Void", gear: {}, runsDone: 0, valorGoal: 3436, crestGoal: 390, activeRunId: 'd8', targetDate: "2026-03-02" }];
            saveProfiles();
        }

        activeProfileId = profiles[0].id;
        if(localStorage.getItem('dt_activeId')) activeProfileId = parseInt(localStorage.getItem('dt_activeId'));
        if(!profiles.find(p => p.id === activeProfileId)) activeProfileId = profiles[0].id;

        updateProfileSelect();
        renderSettings();
        populateDropdown(); 
        loadProfile(activeProfileId);
    };

    function getActiveProfile() { return profiles.find(p => p.id === activeProfileId); }
    function saveProfiles() { localStorage.setItem('dt_profiles', JSON.stringify(profiles)); localStorage.setItem('dt_activeId', activeProfileId); }

    function switchProfile(id) {
        activeProfileId = parseInt(id);
        saveProfiles();
        loadProfile(activeProfileId);
    }

    function loadProfile(id) {
        const p = profiles.find(p => p.id === id);
        applyClassTheme(p.class);
        document.getElementById('charName').value = p.name;
        document.getElementById('valorGoalInput').value = p.valorGoal;
        document.getElementById('crestGoalInput').value = p.crestGoal;
        document.getElementById('targetDate').value = p.targetDate || "2026-03-02";
        const runSelect = document.getElementById('activeRunSelect');
        if(p.activeRunId) runSelect.value = p.activeRunId;
        renderGearGrid(p.gear);
        calcAvgIlvl();
        render();
    }

    function saveCharName() {
        const p = getActiveProfile();
        p.name = document.getElementById('charName').value;
        saveProfiles();
        updateProfileSelect();
    }

    function updateProfileSelect() {
        const sel = document.getElementById('profileSelect');
        sel.innerHTML = '';
        profiles.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.text = `${p.name} (${p.class})`;
            if(p.id === activeProfileId) opt.selected = true;
            sel.appendChild(opt);
        });
    }

    function createProfile() {
        const name = document.getElementById('newCharName').value || "New Character";
        const cls = document.getElementById('newCharClass').value;
        const newP = { id: Date.now(), name: name, class: cls, gear: {}, runsDone: 0, valorGoal: 3436, crestGoal: 390, activeRunId: 'd8', targetDate: "2026-03-02" };
        profiles.push(newP);
        activeProfileId = newP.id;
        saveProfiles();
        updateProfileSelect();
        closeModal();
        loadProfile(activeProfileId);
    }

    function deleteProfile() {
        if(profiles.length <= 1) { alert("Cannot delete the last profile."); return; }
        if(confirm("Delete this character? This cannot be undone.")) {
            profiles = profiles.filter(p => p.id !== activeProfileId);
            activeProfileId = profiles[0].id;
            saveProfiles();
            updateProfileSelect();
            loadProfile(activeProfileId);
        }
    }

    function applyClassTheme(cls) {
        if(cls === "Void") document.documentElement.removeAttribute('data-theme');
        else document.documentElement.setAttribute('data-theme', cls);
    }

    function getIlvl(tier, rankStr) {
        if(tier === 'None' || tier === 'Crafted') return 0;
        const range = ILVL_RANGES[tier] || [0,0];
        if (!rankStr) return range[0];
        const parts = rankStr.split('/');
        const rankIndex = parts.length > 0 ? (parseInt(parts[0]) - 1) : 0; 
        const step = (range[1] - range[0]) / 7;
        return Math.round(range[0] + (step * rankIndex));
    }

    function renderGearGrid(gearData) {
        const grid = document.getElementById('gearGrid');
        grid.innerHTML = '';
        SLOTS.forEach(slot => {
            let savedSlot = gearData[slot] || { tier: 'Veteran', level: '1/8', customIlvl: 150 };
            
            const div = document.createElement('div');
            div.className = 'gear-slot';
            div.setAttribute('data-rarity', savedSlot.tier);
            
            const isCrafted = savedSlot.tier === 'Crafted';
            const isNone = savedSlot.tier === 'None';
            let displayIlvl = '-';
            if(isCrafted) displayIlvl = savedSlot.customIlvl || 0;
            else if(!isNone) displayIlvl = getIlvl(savedSlot.tier, savedSlot.level);

            div.innerHTML = `
                <span class="slot-label">${slot}</span>
                <select class="slot-select tier-select" onchange="updateSlot('${slot}', this, 'tier')">
                    ${TIERS.map(t => `<option value="${t}" ${t === savedSlot.tier ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
                <select class="slot-select level-select" style="${(isCrafted || isNone) ? 'display:none' : 'display:block'}" onchange="updateSlot('${slot}', this, 'level')">
                    ${LEVELS.map(l => `<option value="${l}" ${l === savedSlot.level ? 'selected' : ''}>${l}</option>`).join('')}
                </select>
                <input type="number" class="crafted-input" style="${isCrafted ? 'display:block' : 'display:none'}" value="${savedSlot.customIlvl || 150}" onchange="updateSlot('${slot}', this, 'customIlvl')">
                <span class="item-ilvl">${displayIlvl}</span>
            `;
            grid.appendChild(div);
        });
    }

    function updateSlot(slot, el, field) {
        const p = getActiveProfile();
        if(!p.gear[slot]) p.gear[slot] = { tier: 'Veteran', level: '1/8', customIlvl: 150 };
        p.gear[slot][field] = el.value;
        saveProfiles();
        renderGearGrid(p.gear); 
        calcAvgIlvl();
    }

    function calcAvgIlvl() {
        let total = 0, count = 0;
        document.querySelectorAll('.item-ilvl').forEach(span => {
            const val = span.innerText;
            if(val !== '-') { total += parseInt(val); count++; }
        });
        document.getElementById('avgIlvl').innerText = count > 0 ? (total/count).toFixed(1) : 0;
    }

    function render() {
        const p = getActiveProfile();
        p.activeRunId = document.getElementById('activeRunSelect').value;
        saveProfiles();

        let activeRun = config.delves.find(d => d.id === p.activeRunId);
        if(!activeRun) activeRun = config.dungeons.find(d => d.id === p.activeRunId);
        if(!activeRun) return; 

        document.getElementById('infoValor').innerText = activeRun.valor;
        const rate = CONVERSION[activeRun.type];
        const effectiveGain = activeRun.amt * rate;
        const displayDiv = document.getElementById('conversionDisplay');
        if(activeRun.type === "Gilded") {
            displayDiv.innerHTML = `Drops <span class="crest-gilded">${activeRun.amt} Gilded</span>`;
        } else {
            const approx = effectiveGain.toFixed(2).replace(/[.,]00$/, "");
            displayDiv.innerHTML = `Drops <span class="crest-${activeRun.type.toLowerCase()}">${activeRun.type} ${activeRun.type}</span> (≈ <span class="crest-gilded">${approx} Gilded</span>)`;
        }

        const vpr = activeRun.valor || 99999;
        const cpr = effectiveGain === 0 ? 0.0001 : effectiveGain;
        const runsForValor = Math.ceil(p.valorGoal / vpr);
        const runsForCrests = Math.ceil(p.crestGoal / cpr);
        const startRuns = Math.max(runsForValor, runsForCrests);
        
        let remaining = startRuns - p.runsDone;
        if(remaining < 0) remaining = 0;

        document.getElementById('runsRemaining').innerText = remaining;

        let valorReal = p.valorGoal - (p.runsDone * vpr);
        if(valorReal < 0) valorReal = 0;
        document.getElementById('valorReal').innerText = valorReal.toFixed(0);
        document.getElementById('valorBar').style.width = ((p.valorGoal - valorReal)/p.valorGoal * 100) + "%";

        let crestReal = p.crestGoal - (p.runsDone * effectiveGain);
        if(crestReal < 0) crestReal = 0;
        document.getElementById('crestReal').innerText = crestReal.toFixed(0);
        document.getElementById('crestBar').style.width = ((p.crestGoal - crestReal)/p.crestGoal * 100) + "%";
        
        if(remaining === 0) document.getElementById('runsRemaining').style.color = "#00b894";
        else document.getElementById('runsRemaining').style.removeProperty('color');

        calculateWeekly(remaining);
    }

    function calculateWeekly(remaining) {
        const p = getActiveProfile();
        p.targetDate = document.getElementById('targetDate').value;
        saveProfiles();
        const diff = new Date(p.targetDate) - new Date();
        let weeks = diff / (1000 * 60 * 60 * 24 * 7);
        if(weeks < 0) weeks = 0;
        const safeWeeks = Math.max(0.1, weeks);
        document.getElementById('weeksLeft').innerText = weeks.toFixed(1);
        document.getElementById('runsPerWeek').innerText = Math.ceil(remaining / safeWeeks);
        document.getElementById('runsPerDay').innerText = (remaining / safeWeeks / 7).toFixed(1);
    }

    function updateRuns(amt) {
        const p = getActiveProfile();
        p.runsDone += amt;
        if(p.runsDone < 0) p.runsDone = 0;
        saveProfiles();
        render();
    }

    function updateGoals() {
        const p = getActiveProfile();
        p.valorGoal = parseInt(document.getElementById('valorGoalInput').value) || 0;
        p.crestGoal = parseInt(document.getElementById('crestGoalInput').value) || 0;
        saveProfiles();
        render();
    }

    function renderSettings() {
        const dBody = document.getElementById('delveSettingsBody');
        const mBody = document.getElementById('dungeonSettingsBody');
        dBody.innerHTML = ''; mBody.innerHTML = '';
        const buildRow = (item, cat, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="color:var(--theme-color)">${item.name}</td>
            <td><input type="number" value="${item.valor}" onchange="updateConfig('${cat}', ${idx}, 'valor', this.value)"></td>`;
            const types = ['Gilded', 'Runed', 'Carved', 'Weathered'];
            let opts = types.map(t => `<option value="${t}" ${item.type === t ? 'selected' : ''}>${t}</option>`).join('');
            tr.innerHTML += `<td><select onchange="updateConfig('${cat}', ${idx}, 'type', this.value)">${opts}</select></td>
            <td><input type="number" value="${item.amt}" onchange="updateConfig('${cat}', ${idx}, 'amt', this.value)"></td>`;
            return tr;
        };
        config.delves.forEach((item, idx) => dBody.appendChild(buildRow(item, 'delves', idx)));
        config.dungeons.forEach((item, idx) => mBody.appendChild(buildRow(item, 'dungeons', idx)));
    }

    function updateConfig(cat, idx, key, val) {
        if(key === 'valor' || key === 'amt') val = parseInt(val) || 0;
        config[cat][idx][key] = val;
        localStorage.setItem('dt_config', JSON.stringify(config));
        populateDropdown();
        render();
    }

    function populateDropdown() {
        const select = document.getElementById('activeRunSelect');
        const currentVal = select.value;
        select.innerHTML = '';
        const addOpts = (list, label) => {
            const grp = document.createElement('optgroup'); grp.label = label;
            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.text = item.name;
                grp.appendChild(opt);
            });
            select.appendChild(grp);
        };
        addOpts(config.delves, "Delves");
        addOpts(config.dungeons, "Mythic Dungeons");
        if(currentVal) select.value = currentVal;
    }

    function resetDefaults() {
        if(confirm("Reset GLOBAL settings to defaults?")) {
            config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
            localStorage.setItem('dt_config', JSON.stringify(config));
            renderSettings();
            populateDropdown();
            render();
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        const buttons = document.querySelectorAll('.tab-btn');
        if(tab === 'dashboard') buttons[0].classList.add('active'); else buttons[1].classList.add('active');
    }

    function switchConfigSub(mode) {
        document.getElementById('cfg-delves').classList.remove('active');
        document.getElementById('cfg-dungeons').classList.remove('active');
        document.getElementById('btn-cfg-delves').classList.remove('active');
        document.getElementById('btn-cfg-dungeons').classList.remove('active');
        document.getElementById('cfg-' + mode).classList.add('active');
        document.getElementById('btn-cfg-' + mode).classList.add('active');
    }

    function openModal() { document.getElementById('newCharModal').style.display = 'block'; }
    function closeModal() { document.getElementById('newCharModal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('newCharModal')) closeModal(); }
</script>

</body>
</html>


